<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccBox</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50' y='50' dominant-baseline='central' text-anchor='middle' font-size='80'>🍯</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600&family=JetBrains+Mono&family=Orbitron:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" id="mainStyle">
    <script>document.getElementById('mainStyle').href = 'style.css?v=' + Date.now();</script>
</head>
<body>
    <!-- 赛博背景 -->
    <div class="cyber-bg">
        <div class="cyber-grid"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    <!-- 扫描线效果 -->
    <div class="scanline"></div>
    
    <!-- 主题切换动画层 -->
    <div class="flash-overlay" id="flashOverlay"></div>
    
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <button class="theme-toggle-login" onclick="toggleTheme(event)" id="themeBtn2"><span class="icon">🌙</span></button>
            <div class="login-logo">
                <h1>
                    <span class="honey-icon">🍯</span>
                    <span>AccBox</span>
                </h1>
                <p>安全管理您的账号小金库</p>
            </div>
            <div class="login-tabs">
                <div class="login-tab active" onclick="switchLoginTab('login')"><span>登录</span></div>
                <div class="login-tab" onclick="switchLoginTab('register')"><span>注册</span></div>
            </div>
            <form class="login-form active" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <div class="input-wrapper">
                        <input type="text" class="form-input" id="loginUsername" placeholder="输入您的用户名" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <div class="input-wrapper">
                        <input type="password" class="form-input" id="loginPassword" placeholder="输入您的密码" required>
                    </div>
                </div>
                <button type="submit" class="btn-submit"><span>🔓 解锁金库</span></button>
            </form>
            <form class="login-form" id="registerForm" onsubmit="handleRegister(event)" autocomplete="off">
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <div class="input-wrapper">
                        <input type="text" class="form-input" id="regUsername" placeholder="创建您的用户名" required autocomplete="off" name="reg-user-new">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <div class="input-wrapper">
                        <input type="password" class="form-input" id="regPassword" placeholder="设置安全密码" required autocomplete="new-password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">确认密码</label>
                    <div class="input-wrapper">
                        <input type="password" class="form-input" id="regPassword2" placeholder="再次输入密码" required autocomplete="new-password">
                    </div>
                </div>
                <button type="submit" class="btn-submit"><span>🔐 创建金库</span></button>
            </form>
        </div>
    </div>
    <div class="app" id="app">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo"><span>🍯</span><span>AccBox</span></div>
                <div class="header-btns">
                    <button class="btn-header btn-avatar" onclick="toggleUserPanel()" id="userAvatar" title="个人设置">👤</button>
                    <button class="btn-header" onclick="toggleSidebar()">◀</button>
                </div>
                <!-- 用户面板（头像点击弹出） -->
                <div class="user-panel" id="userPanel">
                    <div class="user-panel-header">
                        <div class="user-avatar-large" id="userAvatarLarge">👤</div>
                        <div class="user-name" id="userDisplayName"></div>
                    </div>
                    <div class="user-panel-body">
                        <div class="user-panel-item" onclick="openAvatarPicker()">🎨 更换头像</div>
                        <div class="user-panel-item" onclick="openFavStylePicker()">💌 收藏样式</div>
                        <div class="user-panel-item" onclick="toggleTimeBadge()"><span id="timeBadgeIcon">⏰️</span> 时间提醒 <span class="toggle-status" id="timeBadgeStatus">开</span></div>
                        <div class="user-panel-item" onclick="openPasswordReset()">🔑 重置密码</div>
                        <div class="user-panel-item" onclick="toggleTheme(event)"><span id="themeBtn">🌙</span> 切换主题</div>
                        <a class="user-panel-item" href="https://github.com/shleeshlee/account-manager" target="_blank" style="text-decoration:none;color:inherit;">🌻 1one/GitHub</a>
                    </div>
                    <div class="user-panel-footer">
                        <button class="btn-logout-full" onclick="logout()">退出登录</button>
                    </div>
                </div>
            </div>
            <div class="sidebar-content">
                <div class="view-section">
                    <div class="section-label">视图</div>
                    <div class="nav-item active" data-view="all" onclick="setView('all')"><span class="nav-icon">📋</span><span class="nav-label">全部账号</span><span class="nav-count" id="countAll">0</span></div>
                    <div class="nav-item" data-view="favorites" onclick="setView('favorites')"><span class="nav-icon">💌</span><span class="nav-label">所有收藏</span><span class="nav-count" id="countFav">0</span></div>
                    <div class="nav-item" data-view="nocombo" onclick="setView('nocombo')"><span class="nav-icon">💤</span><span class="nav-label">无属性组</span><span class="nav-count" id="countNoCombo">0</span></div>
                    <div class="nav-item" data-view="recent" onclick="setView('recent')"><span class="nav-icon">🕐</span><span class="nav-label">最近使用</span><span class="nav-count" id="countRecent">0</span></div>
                </div>
                <div id="sidebarTypes"></div>
                <div id="sidebarProperties"></div>
                <button class="add-group-btn" onclick="openPropertyManager()">+ 添加属性组</button>
            </div>
        </aside>

        <main class="main">
            <div class="toolbar">
                <button class="btn-menu" onclick="toggleSidebar()">☰</button>
                <h1 class="page-title" id="pageTitle">全部账号</h1>
                <div class="toolbar-spacer"></div>
                <!-- 批量操作栏 -->
                <div class="batch-actions" id="batchActions">
                    <span class="batch-count" id="batchCount">已选 0 项</span>
                    <button class="btn-batch-select" onclick="toggleSelectAll()">全选</button>
                    <button class="btn-batch-props" onclick="openBatchPropsModal()"><span class="pc-only">🏷️ 修改属性</span><span class="mobile-only">🏷️</span></button>
                    <button class="btn-batch-delete" onclick="batchDelete()"><span class="pc-only">删除</span><span class="mobile-only">🗑️</span></button>
                </div>
                <!-- 搜索框 -->
                <div class="search-box"><span class="search-icon">🔍</span><input type="search" id="searchInput" placeholder="搜索..." oninput="filterAccounts()" autocomplete="off" data-lpignore="true" data-form-type="other" role="searchbox"></div>
                <!-- 视图切换 -->
                <div class="view-toggle">
                    <button class="view-btn active" data-view="card" onclick="setViewMode('card')" title="卡片视图">🃏</button>
                    <button class="view-btn" data-view="list" onclick="setViewMode('list')" title="列表视图">☰</button>
                </div>
                <!-- PC端按钮（带文字） -->
                <button class="btn-toolbar pc-only" id="btnBatchMode" onclick="toggleBatchMode()" title="批量选择">✅ 勾选账号</button>
                <button class="btn-toolbar pc-only" onclick="openImportModal()" title="导入数据">📥 导入</button>
                <button class="btn-toolbar pc-only" onclick="exportData()" title="导出数据">📤 导出</button>
                <button class="btn-primary pc-only" onclick="openAddModal()">➕ 添加账号</button>
                <!-- 移动端按钮（纯emoji） -->
                <button class="btn-toolbar-sm mobile-only" id="btnBatchModeMobile" onclick="toggleBatchMode()" title="勾选">✅ <span class="mobile-btn-text">勾选</span></button>
                <div class="tools-menu-wrapper mobile-only">
                    <button class="btn-toolbar-sm" onclick="toggleToolsMenu()" title="更多">⚙️</button>
                    <div class="tools-menu" id="toolsMenu">
                        <div class="tools-menu-item" onclick="openAddModal();closeToolsMenu()">➕ 添加账号</div>
                        <div class="tools-menu-item" onclick="openImportModal();closeToolsMenu()">📥 导入数据</div>
                        <div class="tools-menu-item" onclick="exportData();closeToolsMenu()">📤 导出数据</div>
                    </div>
                </div>
            </div>
            <div class="content">
                <div class="active-filters" id="activeFilters"></div>
                <div class="sort-bar">
                    <span>排序:</span>
                    <button class="sort-option active" data-sort="recent" onclick="setSort('recent')">最近使用 ↓</button>
                    <button class="sort-option" data-sort="name" onclick="setSort('name')">名称</button>
                    <button class="sort-option" data-sort="created" onclick="setSort('created')">创建时间</button>
                </div>
                <div class="cards-grid" id="cardsList"></div>
            </div>
        </main>
    </div>

    <!-- 账号模态框 -->
    <div class="modal-overlay" id="accountModal">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="accountModalTitle">添加账号</h2><button class="btn-close" onclick="closeAccountModal()">✕</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">账号类型</label><select class="form-select" id="accType"></select></div>
                    <div class="form-group w100"><label class="form-label">国家/地区</label><select class="form-select" id="accCountry">
                        <option value="🌍">🌍 全球</option>
                        <option value="US">🇺🇸 US</option>
                        <option value="JP">🇯🇵 JP</option>
                        <option value="TW">🇹🇼 TW</option>
                        <option value="HK">🇭🇰 HK</option>
                        <option value="SG">🇸🇬 SG</option>
                        <option value="KR">🇰🇷 KR</option>
                        <option value="GB">🇬🇧 GB</option>
                        <option value="DE">🇩🇪 DE</option>
                        <option value="FR">🇫🇷 FR</option>
                        <option value="AU">🇦🇺 AU</option>
                        <option value="CA">🇨🇦 CA</option>
                        <option value="IN">🇮🇳 IN</option>
                        <option value="VN">🇻🇳 VN</option>
                        <option value="TH">🇹🇭 TH</option>
                        <option value="MY">🇲🇾 MY</option>
                        <option value="ID">🇮🇩 ID</option>
                        <option value="PH">🇵🇭 PH</option>
                        <option value="BR">🇧🇷 BR</option>
                        <option value="RU">🇷🇺 RU</option>
                        <option value="CN">🇨🇳 CN</option>
                    </select></div>
                </div>
                <div class="form-group"><label class="form-label">自定义名称</label><input type="text" class="form-input" id="accName" placeholder="如：API主力号"></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">邮箱/账号</label><input type="text" class="form-input" id="accEmail" autocomplete="off" data-lpignore="true" data-form-type="other" readonly onfocus="this.removeAttribute('readonly')"></div>
                    <div class="form-group"><label class="form-label">密码（可选）</label>
                        <div class="password-input-wrapper">
                            <input type="text" class="form-input pwd-field" id="accPassword" autocomplete="off" data-lpignore="true" data-form-type="other" readonly onfocus="this.removeAttribute('readonly')">
                            <button type="button" class="btn-toggle-pwd" onclick="togglePasswordVisibility()" title="显示/隐藏密码">👁️</button>
                            <button type="button" class="btn-generate-pwd" onclick="generateAndFillPassword()" title="生成16位随机密码">🎲</button>
                        </div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">服务状态</label><div class="combos-box" id="accCombosBox"></div></div>
                <div class="form-group"><label class="form-label">标签</label><div class="tags-input-box" id="accTagsBox"><input type="text" class="tag-input" id="accTagInput" placeholder="回车添加" onkeydown="handleTagInput(event)"></div></div>
                <div class="form-group"><label class="form-label">备注</label><textarea class="form-textarea" id="accNotes"></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn-2fa-config" id="btn2FAConfig" onclick="open2FAConfig(editingAccountId)" style="display:none">🛡️ 2FA</button>
                <button class="btn-cancel" onclick="closeAccountModal()">取消</button>
                <button class="btn-save" onclick="saveAccount()">保存</button>
            </div>
        </div>
    </div>

    <!-- 属性组模态框 -->
    <div class="modal-overlay" id="propertyModal">
        <div class="modal wide"><div class="modal-header"><h2 class="modal-title">管理属性组</h2><button class="btn-close" onclick="closePropertyManager()">✕</button></div><div class="modal-body" id="propertyEditorBody"></div></div>
    </div>

    <!-- 类型模态框 -->
    <div class="modal-overlay" id="typeModal">
        <div class="modal wide"><div class="modal-header"><h2 class="modal-title">管理账号类型</h2><button class="btn-close" onclick="closeTypeManager()">✕</button></div><div class="modal-body" id="typeEditorBody"></div></div>
    </div>

    <!-- 导入模态框 -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title">导入数据</h2><button class="btn-close" onclick="closeImportModal()">✕</button></div>
            <div class="modal-body">
                <div class="import-section">
                    <div class="import-section-title">📁 从JSON文件导入（完整备份）</div>
                    <div class="hint-box"><p>选择或拖拽JSON备份文件到下方区域</p></div>
                    <div class="form-group">
                        <label class="import-file-label drop-zone" id="dropZone" for="importFile">
                            <span class="import-file-icon">📄</span>
                            <span class="import-file-text">点击选择 或 拖拽文件到这里</span>
                            <span class="import-file-hint">支持 .json 备份文件</span>
                        </label>
                        <input type="file" class="import-file-input" id="importFile" accept=".json" onchange="handleImportFile(event)">
                    </div>
                </div>
                <div class="import-divider"><span>或</span></div>
                <div class="import-section">
                    <div class="import-section-title">📝 从CSV文本导入（批量添加）</div>
                    <div class="hint-box"><p>每行格式：邮箱,密码,国家,名称（后两项可选）</p></div>
                    <div class="form-group"><textarea class="form-textarea" id="importCsv" placeholder="example@gmail.com,password123,US,主账号&#10;backup@gmail.com,pass456"></textarea></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn-cancel" onclick="closeImportModal()">取消</button><button class="btn-save" onclick="doImport()">导入CSV</button></div>
        </div>
    </div>

    <!-- 导入重复确认 -->
    <div class="modal-overlay" id="duplicateModal">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title">⚠️ 发现重复</h2><button class="btn-close" onclick="closeDuplicateModal()">✕</button></div>
            <div class="modal-body">
                <div class="duplicate-summary" id="duplicateSummary"></div>
                <div class="duplicate-list" id="duplicateList"></div>
            </div>
            <div class="modal-footer duplicate-footer">
                <button class="btn-cancel" onclick="closeDuplicateModal()">取消</button>
                <button class="btn-option" onclick="importWithOption('skip')">跳过重复</button>
                <button class="btn-option btn-warning" onclick="importWithOption('overwrite')">覆盖</button>
                <button class="btn-save" onclick="importWithOption('all')">全部导入</button>
            </div>
        </div>
    </div>

    <!-- 密码重置模态框 -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal small">
            <div class="modal-header"><h2 class="modal-title">🔑 重置密码</h2><button class="btn-close" onclick="closePasswordModal()">✕</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">当前密码</label><input type="password" class="form-input" id="oldPassword" required></div>
                <div class="form-group"><label class="form-label">新密码</label><input type="password" class="form-input" id="newPassword" required></div>
                <div class="form-group"><label class="form-label">确认新密码</label><input type="password" class="form-input" id="newPassword2" required></div>
            </div>
            <div class="modal-footer"><button class="btn-cancel" onclick="closePasswordModal()">取消</button><button class="btn-save" onclick="submitPasswordReset()">确认修改</button></div>
        </div>
    </div>

    <!-- 头像选择模态框 -->
    <div class="modal-overlay" id="avatarModal">
        <div class="modal small">
            <div class="modal-header"><h2 class="modal-title">🎨 选择头像</h2><button class="btn-close" onclick="closeAvatarModal()">✕</button></div>
            <div class="modal-body">
                <div class="avatar-grid" id="avatarGrid"></div>
            </div>
        </div>
    </div>

    <!-- 收藏样式选择模态框 -->
    <div class="modal-overlay" id="favStyleModal">
        <div class="modal small">
            <div class="modal-header"><h2 class="modal-title">💌 收藏便签样式</h2><button class="btn-close" onclick="closeFavStyleModal()">✕</button></div>
            <div class="modal-body">
                <div class="fav-style-grid" id="favStyleGrid"></div>
            </div>
        </div>
    </div>

    <!-- 2FA 配置模态框 (v5.0 新增二维码扫描) -->
    <div class="modal-overlay" id="twoFAConfigModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">🛡️ 配置双重验证 (2FA)</h2>
                <button class="btn-close" onclick="close2FAConfigModal()">✕</button>
            </div>
            <div class="modal-body">
                <!-- 二维码上传区域 -->
                <div class="form-group">
                    <label class="form-label">📷 扫描二维码</label>
                    <div class="qr-upload-zone" id="qrUploadZone" onclick="document.getElementById('qrFileInput').click()">
                        <input type="file" id="qrFileInput" accept="image/*" style="display:none" onchange="handleQRUpload(event)">
                        <div class="qr-upload-content">
                            <div class="qr-upload-icon">📸</div>
                            <div class="qr-upload-text">点击上传或拖拽二维码图片</div>
                            <div class="qr-upload-hint">支持 Google Authenticator、Microsoft Authenticator 等</div>
                        </div>
                        <canvas id="qrCanvas" style="display:none"></canvas>
                    </div>
                    <div class="qr-scan-result" id="qrScanResult" style="display:none"></div>
                </div>

                <div class="import-divider"><span>或手动输入</span></div>

                <!-- 手动配置 -->
                <div class="form-group">
                    <label class="form-label">🔑 密钥 (Secret)</label>
                    <input type="text" class="form-input" id="totp2FASecret" placeholder="Base32 密钥，如 JBSWY3DPEHPK3PXP" autocomplete="off" name="totp-secret-nofill">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">📛 发行方 (Issuer)</label>
                        <input type="text" class="form-input" id="totp2FAIssuer" placeholder="如 Google、Steam">
                    </div>
                    <div class="form-group">
                        <label class="form-label">🔢 类型</label>
                        <select class="form-input" id="totp2FAType">
                            <option value="totp">标准 TOTP (6位数字)</option>
                            <option value="steam">Steam Guard (5位字母)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">🔐 算法</label>
                        <select class="form-input" id="totp2FAAlgorithm">
                            <option value="SHA1">SHA1 (默认)</option>
                            <option value="SHA256">SHA256</option>
                            <option value="SHA512">SHA512</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">#️⃣ 位数</label>
                        <select class="form-input" id="totp2FADigits">
                            <option value="6">6 位</option>
                            <option value="8">8 位</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">⏱️ 时间偏移 (秒)</label>
                    <input type="number" class="form-input" id="totp2FATimeOffset" value="0" placeholder="服务器时间差，通常为 0">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-danger" id="btn2FADelete" onclick="delete2FAFromModal()" style="display:none">🗑️ 移除 2FA</button>
                <div style="flex:1"></div>
                <button class="btn-secondary" onclick="close2FAConfigModal()">取消</button>
                <button class="btn-primary" onclick="save2FAConfig()">💾 保存配置</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    
    <!-- HTTP安全提示栏 -->
    <div class="http-warning" id="httpWarning" style="display:none;">
        <span class="http-warning-icon">⚠️</span>
        <span class="http-warning-text">当前处于 HTTP 不安全模式，数据可能被窃听。建议尽快配置 HTTPS。</span>
        <button class="http-warning-close" onclick="dismissHttpWarning()">✕</button>
    </div>
    
    <!-- jsQR 二维码识别库 -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        // 动态加载JS，先加载flags，再加载app
        const flagsScript = document.createElement('script');
        flagsScript.src = 'flags.js?v=' + Date.now();
        flagsScript.onload = function() {
            const appScript = document.createElement('script');
            appScript.src = 'app.js?v=' + Date.now();
            document.body.appendChild(appScript);
        };
        document.body.appendChild(flagsScript);
    </script>
</body>
</html>
