<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccBox</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50' y='50' dominant-baseline='central' text-anchor='middle' font-size='80'>🍯</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600&family=JetBrains+Mono&family=Orbitron:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" id="mainStyle">
    <script>document.getElementById('mainStyle').href = 'style.css?v=' + Date.now();</script>
</head>
<body data-season="none">
    <!-- 季节粒子容器 -->
    <div class="season-particles" id="seasonParticles"></div>
    
    <!-- 赛博背景 -->
    <div class="cyber-bg">
        <div class="cyber-grid"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    <!-- 扫描线效果 -->
    <div class="scanline"></div>
    
    <!-- 主题切换动画层 -->
    <div class="flash-overlay" id="flashOverlay"></div>
    
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <button class="theme-toggle-login" onclick="switchThemeWithEffect(event)" id="themeBtn2"><span class="icon">🌙</span></button>
            <div class="login-logo">
                <h1>
                    <span class="honey-icon">🍯</span>
                    <span>AccBox</span>
                </h1>
                <p>安全管理您的账号小金库</p>
            </div>
            <div class="login-tabs">
                <div class="login-tab active" onclick="switchLoginTab('login')"><span>登录</span></div>
                <div class="login-tab" onclick="switchLoginTab('register')"><span>注册</span></div>
            </div>
            <form class="login-form active" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <div class="input-wrapper">
                        <input type="text" class="form-input" id="loginUsername" placeholder="输入您的用户名" required autocomplete="username">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <div class="input-wrapper">
                        <input type="password" class="form-input" id="loginPassword" placeholder="输入您的密码" required autocomplete="current-password">
                    </div>
                </div>
                <button type="submit" class="btn-submit"><span>🔓 解锁金库</span></button>
            </form>
            <form class="login-form" id="registerForm" onsubmit="handleRegister(event)" autocomplete="off">
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <div class="input-wrapper">
                        <input type="text" class="form-input" id="regUsername" placeholder="创建您的用户名" required autocomplete="off" name="reg-user-new">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <div class="input-wrapper">
                        <input type="password" class="form-input" id="regPassword" placeholder="设置安全密码" required autocomplete="new-password">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">确认密码</label>
                    <div class="input-wrapper">
                        <input type="password" class="form-input" id="regPassword2" placeholder="再次输入密码" required autocomplete="new-password">
                    </div>
                </div>
                <button type="submit" class="btn-submit"><span>🔐 创建金库</span></button>
            </form>
        </div>
    </div>
    <div class="app" id="app">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo"><span>🍯</span><span>AccBox</span></div>
                <div class="header-btns">
                    <button class="btn-header btn-avatar" onclick="toggleUserPanel()" id="userAvatar" title="个人设置">👤</button>
                    <button class="btn-header" onclick="toggleSidebar()">◀</button>
                </div>
                <!-- 用户面板（头像点击弹出） -->
                <div class="user-panel" id="userPanel">
                    <div class="user-panel-header">
                        <div class="user-avatar-large" id="userAvatarLarge">👤</div>
                        <div class="user-name" id="userDisplayName"></div>
                    </div>
                    <div class="user-panel-body">
                        <div class="user-panel-item" onclick="openAvatarPicker()">🎨 更换头像</div>
                        <div class="user-panel-item" onclick="openFavStylePicker()">💌 收藏样式</div>
                        <div class="user-panel-item" onclick="openPasswordReset()">🔑 重置密码</div>
                        <div class="user-panel-item" onclick="toggleTheme(event)"><span id="themeBtn">🌙</span> 切换主题</div>
                        <div class="user-panel-item" onclick="openSeasonPicker()"><span id="seasonIcon">❄️</span> 季节主题 <span class="toggle-status" id="seasonStatus">自动</span></div>
                        <a class="user-panel-item" href="https://github.com/shleeshlee/account-manager" target="_blank" style="text-decoration:none;color:inherit;">🌻 1one/GitHub</a>
                    </div>
                    <div class="user-panel-footer">
                        <button class="btn-logout-full" onclick="logout()">退出登录</button>
                    </div>
                </div>
            </div>
            <div class="sidebar-content">
                <div class="view-section">
                    <div class="section-label">视图</div>
                    <div class="nav-item active" data-view="all" onclick="setView('all')"><span class="nav-icon">📋</span><span class="nav-label">全部账号</span><span class="nav-count" id="countAll">0</span></div>
                    <div class="nav-item" data-view="favorites" onclick="setView('favorites')" oncontextmenu="excludeView('favorites', event)"><span class="nav-icon">💌</span><span class="nav-label">所有收藏</span><span class="nav-count" id="countFav">0</span></div>
                    <div class="nav-item" data-view="nocombo" onclick="setView('nocombo')" oncontextmenu="excludeView('nocombo', event)"><span class="nav-icon">💤</span><span class="nav-label">无属性组</span><span class="nav-count" id="countNoCombo">0</span></div>
                </div>
                <div id="sidebarTypes"></div>
                <div id="sidebarProperties"></div>
                <button class="add-group-btn" onclick="openPropertyManager()">+ 添加属性组</button>
            </div>
        </aside>

        <main class="main">
            <div class="toolbar">
                <button class="btn-menu" onclick="toggleSidebar()">☰</button>
                <h1 class="page-title" id="pageTitle">全部账号</h1>
                <div class="toolbar-spacer"></div>
                <!-- 批量操作栏 -->
                <div class="batch-actions" id="batchActions">
                    <span class="batch-count" id="batchCount">已选 0 项</span>
                    <button class="btn-batch-select" onclick="toggleSelectAll()">全选</button>
                    <button class="btn-batch-props" onclick="openBatchPropsModal()"><span class="pc-only">🏷️ 修改属性</span><span class="mobile-only">🏷️</span></button>
                    <button class="btn-batch-delete" onclick="batchDelete()"><span class="pc-only">删除</span><span class="mobile-only">🗑️</span></button>
                </div>
                
                <!-- === PC端工具栏 === -->
                <!-- 搜索框 -->
                <form class="search-box pc-only" role="search" action="javascript:void(0)" onsubmit="return false"><span class="search-icon">🔍</span><input type="search" id="searchInput" placeholder="搜索..." oninput="filterAccounts()" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" data-1p-ignore="true" data-protonpass-ignore="true" data-bitwarden-ignore="true" role="searchbox" name="q" aria-autocomplete="none"></form>
                <!-- 视图切换 -->
                <div class="view-toggle pc-only">
                    <button class="view-btn active" data-view="card" onclick="setViewMode('card')" title="卡片视图">🃏</button>
                    <button class="view-btn" data-view="list" onclick="setViewMode('list')" title="列表视图">☰</button>
                </div>
                <!-- 勾选 -->
                <button class="btn-toolbar pc-only" id="btnBatchMode" onclick="toggleBatchMode()" title="批量选择">✅ 勾选</button>
                <!-- 添加账号 -->
                <button class="btn-primary pc-only" onclick="openAddModal()">➕ 添加账号</button>
                <!-- 🔔 验证码铃铛 -->
                <div class="notification-wrapper pc-only">
                    <button class="btn-tool-icon" id="notifyBtn" onclick="toggleNotificationPanel()" title="验证码">
                        🔔
                        <span class="notify-badge" id="notifyBadge" style="display:none">0</span>
                    </button>
                </div>
                <!-- 验证码面板（独立，PC和手机共用） -->
                <div class="notification-panel" id="notificationPanel">
                    <div class="panel-header">
                        <span class="panel-title">🔔 验证码</span>
                        <div class="panel-actions">
                            <button class="btn-text" onclick="markAllCodesRead()">全部已读</button>
                            <button class="btn-heart" id="btnRefreshEmails" onclick="fetchEmailsNow()" title="进入1分钟加速模式">
                                <svg class="heart-icon" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="panel-body" id="codesPanelBody">
                        <div class="codes-empty">暂无验证码</div>
                    </div>
                </div>
                <!-- ⋮ 更多菜单 -->
                <div class="more-menu-wrapper pc-only">
                    <button class="btn-tool-icon" id="moreBtn" onclick="toggleMoreMenu()" title="更多">⋮</button>
                    <div class="more-menu" id="moreMenu">
                        <div class="menu-section">
                            <div class="menu-item" onclick="openImportModal();closeMoreMenu()"><span class="menu-icon">📥</span><span class="menu-label">导入数据</span></div>
                            <div class="menu-item" onclick="exportData();closeMoreMenu()"><span class="menu-icon">📤</span><span class="menu-label">导出数据</span></div>
                        </div>
                        <div class="menu-section">
                            <div class="menu-item" onclick="showBackupModal();closeMoreMenu()"><span class="menu-icon">📦</span><span class="menu-label">数据备份</span></div>
                            <div class="menu-item" onclick="toggleTimeBadge();closeMoreMenu()">
                                <span class="menu-icon" id="menuTimeBadgeIcon">⏰️</span>
                                <span class="menu-label">时间提醒</span>
                                <span class="toggle-status" id="menuTimeBadgeStatus">开</span>
                            </div>
                        </div>
                        <div class="menu-section">
                            <div class="menu-section-title">邮箱验证码</div>
                            <div class="menu-item" onclick="openEmailManager();closeMoreMenu()">
                                <span class="menu-icon">📬</span>
                                <span class="menu-label">邮箱授权</span>
                                <span class="menu-hint" id="emailCountHint">未启用</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === 移动端工具栏 === -->
                <!-- 搜索框（内联） -->
                <form class="search-box-inline mobile-only" role="search" action="javascript:void(0)" onsubmit="return false">
                    <span class="search-icon">🔍</span>
                    <input type="search" id="mobileSearchInput" placeholder="搜索..." oninput="filterAccounts()" autocomplete="off">
                </form>
                <!-- 视图切换（单按钮） -->
                <button class="btn-tool-icon-sm mobile-only" id="mobileViewBtn" onclick="toggleViewMode()" title="切换视图">🃏</button>
                <!-- 勾选 -->
                <button class="btn-tool-icon-sm mobile-only" id="btnBatchModeMobile" onclick="toggleBatchMode()" title="勾选">✅</button>
                <!-- 🔔 验证码铃铛 -->
                <button class="btn-tool-icon-sm mobile-only" id="mobileNotifyBtn" onclick="toggleMobileNotificationPanel(event)" title="验证码">
                    🔔
                    <span class="notify-badge" id="mobileNotifyBadge" style="display:none">0</span>
                </button>
                <!-- ⋮ 更多菜单 -->
                <button class="btn-tool-icon-sm mobile-only" id="mobileMoreBtn" onclick="toggleMoreMenu()" title="更多">⋮</button>
            </div>
            <div class="content">
                <div class="active-filters" id="activeFilters"></div>
                <div class="sort-bar">
                    <span>排序:</span>
                    <button class="sort-option active" data-sort="recent" onclick="setSort('recent')">最近使用 ↓</button>
                    <button class="sort-option" data-sort="name" onclick="setSort('name')">名称</button>
                    <button class="sort-option" data-sort="created" onclick="setSort('created')">创建时间</button>
                </div>
                <div class="cards-grid" id="cardsList"></div>
            </div>
        </main>
    </div>

    <!-- 账号模态框 -->
    <div class="modal-overlay" id="accountModal">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="accountModalTitle">添加账号</h2><button class="btn-close" onclick="closeAccountModal()">✕</button></div>
            <form class="modal-body" autocomplete="off" onsubmit="return false" data-form-type="other">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">账号类型</label><select class="form-select" id="accType"></select></div>
                    <div class="form-group w100"><label class="form-label">国家/地区</label><select class="form-select" id="accCountry">
                        <option value="🌍">🌍 全球</option>
                        <option value="US">🇺🇸 US</option>
                        <option value="JP">🇯🇵 JP</option>
                        <option value="TW">🇹🇼 TW</option>
                        <option value="HK">🇭🇰 HK</option>
                        <option value="SG">🇸🇬 SG</option>
                        <option value="KR">🇰🇷 KR</option>
                        <option value="GB">🇬🇧 GB</option>
                        <option value="DE">🇩🇪 DE</option>
                        <option value="FR">🇫🇷 FR</option>
                        <option value="AU">🇦🇺 AU</option>
                        <option value="CA">🇨🇦 CA</option>
                        <option value="IN">🇮🇳 IN</option>
                        <option value="VN">🇻🇳 VN</option>
                        <option value="TH">🇹🇭 TH</option>
                        <option value="MY">🇲🇾 MY</option>
                        <option value="ID">🇮🇩 ID</option>
                        <option value="PH">🇵🇭 PH</option>
                        <option value="BR">🇧🇷 BR</option>
                        <option value="RU">🇷🇺 RU</option>
                        <option value="CN">🇨🇳 CN</option>
                    </select></div>
                </div>
                <div class="form-group"><label class="form-label">自定义名称</label><input type="text" class="form-input" id="accName" placeholder="如：API主力号"></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">邮箱/账号</label><input type="text" class="form-input" id="accEmail" autocomplete="off" autocorrect="off" autocapitalize="off" data-lpignore="true" data-1p-ignore="true" data-protonpass-ignore="true" data-form-type="other" name="accbox_email_nofill_xyz" readonly onfocus="this.removeAttribute('readonly')"></div>
                    <div class="form-group"><label class="form-label">密码（可选）</label>
                        <div class="password-input-wrapper">
                            <input type="text" class="form-input pwd-field" id="accPassword" autocomplete="off" autocorrect="off" autocapitalize="off" data-lpignore="true" data-1p-ignore="true" data-protonpass-ignore="true" data-form-type="other" name="accbox_pwd_nofill_xyz" readonly onfocus="this.removeAttribute('readonly')">
                            <button type="button" class="btn-toggle-pwd" onclick="togglePasswordVisibility()" title="显示/隐藏密码">👁️</button>
                            <button type="button" class="btn-generate-pwd" onclick="generateAndFillPassword()" title="生成16位随机密码">🎲</button>
                        </div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">服务状态</label><div class="combos-box" id="accCombosBox"></div></div>
                <!-- 辅助邮箱（验证码接收） -->
                <div class="form-group">
                    <label class="form-label">📬 辅助邮箱 <span class="form-label-hint">（验证码接收，可选）</span></label>
                    <div class="backup-email-wrapper">
                        <input type="email" class="form-input" id="accBackupEmail" placeholder="如：backup@gmail.com" autocomplete="off" oninput="onBackupEmailInput(this)">
                        <div class="backup-email-suggestions" id="backupEmailSuggestions"></div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">标签</label><div class="tags-input-box" id="accTagsBox"><input type="text" class="tag-input" id="accTagInput" placeholder="回车添加" onkeydown="handleTagInput(event)"></div></div>
                <div class="form-group"><label class="form-label">备注</label><textarea class="form-textarea" id="accNotes"></textarea></div>
            </form>
            <div class="modal-footer">
                <button class="btn-2fa-config" id="btn2FAConfig" onclick="open2FAConfig(editingAccountId)" style="display:none">🛡️ 2FA</button>
                <button class="btn-cancel" onclick="closeAccountModal()">取消</button>
                <button class="btn-save" onclick="saveAccount()">保存</button>
            </div>
        </div>
    </div>

    <!-- 属性组模态框 -->
    <div class="modal-overlay" id="propertyModal">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title"><span class="modal-title-icon">🏷️</span>管理属性组</h2>
                <div class="modal-header-actions">
                    <button class="help-toggle-btn" id="propHelpBtn" onclick="togglePropertyHelp()" title="帮助">?</button>
                    <button class="btn-close" onclick="closePropertyManager()">✕</button>
                </div>
            </div>
            <div class="modal-body" id="propertyEditorBody"></div>
        </div>
    </div>
    
    <!-- 属性组帮助气泡 -->
    <div class="help-bubble" id="propertyHelpBubble">
        <div class="help-bubble-header">
            <span>💡</span>
            <span>使用帮助</span>
        </div>
        <div class="help-bubble-content">
            <div class="help-section">
                <div class="help-section-title"><span class="icon">⋮⋮</span>拖拽排序</div>
                <p>拖动属性组调整优先级，<strong>靠前的属性组颜色优先显示</strong>在复合标签中。</p>
            </div>
            <div class="help-section">
                <div class="help-section-title"><span class="icon">👁</span>隐藏文字</div>
                <p>👁 显示 → 点击变为 🙈 隐藏。隐藏后文字不显示，但<strong>颜色影响保留</strong>。</p>
                <div class="help-example-wrap">
                    <span class="help-tag" style="--tag-color:#ef4444">不可用 备用</span>
                    <span class="help-arrow">→</span>
                    <span class="help-tag" style="--tag-color:#ef4444">备用</span>
                </div>
            </div>
            <div class="help-section">
                <div class="help-section-title"><span class="icon">🎨</span>颜色选择</div>
                <p>点击左侧色块可更换属性值的颜色。</p>
            </div>
        </div>
    </div>

    <!-- 类型模态框 -->
    <div class="modal-overlay" id="typeModal">
        <div class="modal wide"><div class="modal-header"><h2 class="modal-title">管理账号类型</h2><button class="btn-close" onclick="closeTypeManager()">✕</button></div><div class="modal-body" id="typeEditorBody"></div></div>
    </div>

    <!-- 导入模态框 -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title">导入数据</h2><button class="btn-close" onclick="closeImportModal()">✕</button></div>
            <div class="modal-body">
                <div class="import-section">
                    <div class="import-section-title">📁 从JSON文件导入（完整备份）</div>
                    <div class="hint-box"><p>选择或拖拽JSON备份文件到下方区域</p></div>
                    <div class="form-group">
                        <label class="import-file-label drop-zone" id="dropZone" for="importFile">
                            <span class="import-file-icon">📄</span>
                            <span class="import-file-text">点击选择 或 拖拽文件到这里</span>
                            <span class="import-file-hint">支持 .json 备份文件</span>
                        </label>
                        <input type="file" class="import-file-input" id="importFile" accept=".json" onchange="handleImportFile(event)">
                    </div>
                </div>
                <div class="import-divider"><span>或</span></div>
                <div class="import-section">
                    <div class="import-section-title">📝 从CSV文本导入（批量添加）</div>
                    <div class="hint-box"><p>每行格式：邮箱,密码,国家,名称（后两项可选）</p></div>
                    <div class="form-group"><textarea class="form-textarea" id="importCsv" placeholder="example@gmail.com,password123,US,主账号&#10;backup@gmail.com,pass456"></textarea></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn-cancel" onclick="closeImportModal()">取消</button><button class="btn-save" onclick="doImport()">导入CSV</button></div>
        </div>
    </div>

    <!-- 导入重复确认 -->
    <div class="modal-overlay" id="duplicateModal">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title">⚠️ 发现重复</h2><button class="btn-close" onclick="closeDuplicateModal()">✕</button></div>
            <div class="modal-body">
                <div class="duplicate-summary" id="duplicateSummary"></div>
                <div class="duplicate-list" id="duplicateList"></div>
            </div>
            <div class="modal-footer duplicate-footer">
                <button class="btn-cancel" onclick="closeDuplicateModal()">取消</button>
                <button class="btn-option" onclick="importWithOption('skip')">跳过重复</button>
                <button class="btn-option btn-warning" onclick="importWithOption('overwrite')">覆盖</button>
                <button class="btn-save" onclick="importWithOption('all')">全部导入</button>
            </div>
        </div>
    </div>

    <!-- 密码重置模态框 -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal small">
            <div class="modal-header"><h2 class="modal-title">🔑 重置密码</h2><button class="btn-close" onclick="closePasswordModal()">✕</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">当前密码</label><input type="password" class="form-input" id="oldPassword" required autocomplete="current-password"></div>
                <div class="form-group"><label class="form-label">新密码</label><input type="password" class="form-input" id="newPassword" required autocomplete="new-password"></div>
                <div class="form-group"><label class="form-label">确认新密码</label><input type="password" class="form-input" id="newPassword2" required autocomplete="new-password"></div>
            </div>
            <div class="modal-footer"><button class="btn-cancel" onclick="closePasswordModal()">取消</button><button class="btn-save" onclick="submitPasswordReset()">确认修改</button></div>
        </div>
    </div>

    <!-- 头像选择模态框 -->
    <div class="modal-overlay" id="avatarModal">
        <div class="modal small">
            <div class="modal-header"><h2 class="modal-title">🎨 选择头像</h2><button class="btn-close" onclick="closeAvatarModal()">✕</button></div>
            <div class="modal-body">
                <div class="avatar-grid" id="avatarGrid"></div>
            </div>
        </div>
    </div>

    <!-- 收藏样式选择模态框 -->
    <div class="modal-overlay" id="favStyleModal">
        <div class="modal small">
            <div class="modal-header"><h2 class="modal-title">💌 收藏便签样式</h2><button class="btn-close" onclick="closeFavStyleModal()">✕</button></div>
            <div class="modal-body">
                <div class="fav-style-grid" id="favStyleGrid"></div>
            </div>
        </div>
    </div>

    <!-- 2FA 配置模态框 (v5.0 新增二维码扫描) -->
    <div class="modal-overlay" id="twoFAConfigModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">🛡️ 配置双重验证 (2FA)</h2>
                <button class="btn-close" onclick="close2FAConfigModal()">✕</button>
            </div>
            <div class="modal-body">
                <!-- 二维码上传区域 -->
                <div class="form-group">
                    <label class="form-label">📷 扫描二维码</label>
                    <div class="qr-upload-zone" id="qrUploadZone" onclick="document.getElementById('qrFileInput').click()">
                        <input type="file" id="qrFileInput" accept="image/*" style="display:none" onchange="handleQRUpload(event)">
                        <div class="qr-upload-content">
                            <div class="qr-upload-icon">📸</div>
                            <div class="qr-upload-text">点击上传或拖拽二维码图片</div>
                            <div class="qr-upload-hint">支持 Ctrl+V 粘贴截图 / 右键粘贴</div>
                        </div>
                        <canvas id="qrCanvas" style="display:none"></canvas>
                    </div>
                    <div class="qr-scan-result" id="qrScanResult" style="display:none"></div>
                </div>

                <div class="import-divider"><span>或手动输入</span></div>

                <!-- 手动配置 -->
                <div class="form-group">
                    <label class="form-label">🔑 密钥 (Secret)</label>
                    <input type="text" class="form-input" id="totp2FASecret" placeholder="Base32 密钥，如 JBSWY3DPEHPK3PXP" autocomplete="off" name="totp-secret-nofill">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">📛 发行方 (Issuer)</label>
                        <input type="text" class="form-input" id="totp2FAIssuer" placeholder="如 Google、Steam">
                    </div>
                    <div class="form-group">
                        <label class="form-label">🔢 类型</label>
                        <select class="form-input" id="totp2FAType">
                            <option value="totp">标准 TOTP (6位数字)</option>
                            <option value="steam">Steam Guard (5位字母)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">🔐 算法</label>
                        <select class="form-input" id="totp2FAAlgorithm">
                            <option value="SHA1">SHA1 (默认)</option>
                            <option value="SHA256">SHA256</option>
                            <option value="SHA512">SHA512</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">#️⃣ 位数</label>
                        <select class="form-input" id="totp2FADigits">
                            <option value="6">6 位</option>
                            <option value="8">8 位</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">⏱️ 时间偏移 (秒)</label>
                    <input type="number" class="form-input" id="totp2FATimeOffset" value="0" placeholder="服务器时间差，通常为 0">
                </div>
                <div class="form-group">
                    <label class="form-label">🔑 备份码 (可选)</label>
                    <div class="backup-codes-zone" id="backupCodesZone">
                        <textarea class="form-textarea" id="totp2FABackupCodes" rows="4" placeholder="每行一个备份码，支持拖拽 .txt 文件导入&#10;例如：A1B2-C3D4"></textarea>
                        <div class="backup-codes-hint">📄 可拖拽 .txt 文件到此处</div>
                    </div>
                    <div class="backup-codes-preview" id="backupCodesPreview" style="display:none">
                        <div class="backup-codes-grid" id="backupCodesGrid"></div>
                        <button type="button" class="backup-codes-edit-btn" onclick="editBackupCodes()">✏️ 编辑</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-danger" id="btn2FADelete" onclick="delete2FAFromModal()" style="display:none">🗑️ 移除 2FA</button>
                <div style="flex:1"></div>
                <button class="btn-secondary" onclick="close2FAConfigModal()">取消</button>
                <button class="btn-primary" onclick="save2FAConfig()">💾 保存配置</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    
    <!-- HTTP安全提示栏 -->
    <div class="http-warning" id="httpWarning" style="display:none;">
        <span class="http-warning-icon">⚠️</span>
        <span class="http-warning-text">当前处于 HTTP 不安全模式，数据可能被窃听。建议尽快配置 HTTPS。</span>
        <button class="http-warning-close" onclick="dismissHttpWarning()">✕</button>
    </div>
    
    <!-- 数据备份弹窗 -->
    <div class="modal-overlay" id="backupModal">
        <div class="modal backup-modal">
            <div class="modal-header">
                <span class="modal-title">📦 数据备份</span>
                <button class="btn-close" onclick="closeBackupModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- 立即备份 -->
                <div class="backup-section">
                    <div class="backup-section-title">💾 立即备份</div>
                    <div class="backup-row">
                        <button class="btn btn-primary" onclick="createBackup()">📦 备份到服务器</button>
                        <button class="btn btn-success" onclick="downloadBackupToLocal()">⬇️ 下载到本地</button>
                    </div>
                </div>
                
                <!-- 备份记录（点击查看） -->
                <div class="backup-section backup-section-clickable" onclick="showBackupListModal()">
                    <div class="backup-section-title">
                        <span>📋 备份记录</span>
                        <span class="backup-section-right">
                            <span class="backup-count" id="backupCount">0 个</span>
                            <span class="backup-arrow">›</span>
                        </span>
                    </div>
                </div>
                
                <!-- 定时备份 -->
                <details class="backup-details">
                    <summary class="backup-details-summary">⏰ 定时备份</summary>
                    <div class="backup-section">
                        <div class="backup-row compact">
                            <label class="backup-label">备份间隔</label>
                            <select id="autoBackupInterval" class="backup-select" onchange="saveAutoBackupSettings()">
                                <option value="0">关闭</option>
                                <option value="6">每 6 小时</option>
                                <option value="12">每 12 小时</option>
                                <option value="24" selected>每天</option>
                                <option value="72">每 3 天</option>
                                <option value="168">每周</option>
                            </select>
                            <label class="backup-label" style="margin-left:12px">保留</label>
                            <select id="autoBackupKeep" class="backup-select" onchange="saveAutoBackupSettings()">
                                <option value="5">5 个</option>
                                <option value="10" selected>10 个</option>
                                <option value="20">20 个</option>
                                <option value="50">50 个</option>
                            </select>
                        </div>
                        <div class="backup-status" id="autoBackupStatus">定时备份：未启用</div>
                    </div>
                </details>
                
                <!-- 使用说明 -->
                <details class="backup-details" open>
                    <summary class="backup-details-summary">💡 说明</summary>
                    <ul class="backup-tips-list">
                        <li><b>下载到本地</b>：保存到您的电脑，最安全</li>
                        <li><b>备份到服务器</b>：保存到 VPS，方便快速恢复</li>
                        <li><b>定时备份</b>：服务器自动执行，无需保持网页打开</li>
                    </ul>
                    <div class="backup-env-tip">
                        🔑 迁移服务器时，请同时备份 <code>.env</code> 文件（含加密密钥）
                    </div>
                    <div class="backup-env-tip" style="margin-top:8px;color:var(--yellow)">
                        ⚠️ 容器重启后定时备份计时会重置，建议首次启用时先手动备份一次
                    </div>
                </details>
            </div>
        </div>
    </div>
    
    <!-- 备份记录列表弹窗 -->
    <div class="modal-overlay" id="backupListModal">
        <div class="modal backup-list-modal">
            <div class="modal-header">
                <span class="modal-title">📋 备份记录</span>
                <button class="btn-close" onclick="closeBackupListModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="backup-list-container" id="backupListContainer">
                    <div class="backup-empty">加载中...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 季节主题选择弹窗 -->
    <div class="modal-overlay" id="seasonModal">
        <div class="modal season-modal">
            <div class="modal-header">
                <span class="modal-title">🎨 季节主题</span>
                <button class="btn-close" onclick="closeSeasonPicker()">×</button>
            </div>
            <div class="modal-body">
                <div class="season-grid">
                    <div class="season-card" data-season="none" onclick="setSeason('none')">
                        <span class="season-card-icon">🚫</span>
                        <span class="season-card-name">关闭</span>
                        <span class="season-card-desc">不使用季节效果</span>
                    </div>
                    <div class="season-card" data-season="auto" onclick="setSeason('auto')">
                        <span class="season-card-icon">🔄</span>
                        <span class="season-card-name">自动</span>
                        <span class="season-card-desc">跟随真实季节</span>
                    </div>
                    <div class="season-card" data-season="spring" onclick="setSeason('spring')">
                        <span class="season-card-icon">🌸</span>
                        <span class="season-card-name">春</span>
                        <span class="season-card-desc">樱花粉绿</span>
                    </div>
                    <div class="season-card" data-season="summer" onclick="setSeason('summer')">
                        <span class="season-card-icon">🌴</span>
                        <span class="season-card-name">夏</span>
                        <span class="season-card-desc">清凉薄荷</span>
                    </div>
                    <div class="season-card" data-season="autumn" onclick="setSeason('autumn')">
                        <span class="season-card-icon">🍂</span>
                        <span class="season-card-name">秋</span>
                        <span class="season-card-desc">枫叶暖橙</span>
                    </div>
                    <div class="season-card" data-season="winter" onclick="setSeason('winter')">
                        <span class="season-card-icon">❄️</span>
                        <span class="season-card-name">冬</span>
                        <span class="season-card-desc">冰蓝银雪</span>
                    </div>
                </div>
                <div class="season-particle-toggle">
                    <label class="season-toggle-label">
                        <span>✨ 粒子效果</span>
                        <span class="season-toggle-hint">樱花/萤火虫/枫叶/雪花飘落</span>
                    </label>
                    <button class="season-toggle-btn" id="particleToggleBtn" onclick="toggleSeasonParticles()">
                        <span id="particleToggleText">开启</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 邮箱授权模态框 -->
    <div class="modal-overlay" id="emailManagerModal">
        <div class="modal email-modal">
            <div class="modal-header">
                <h2 class="modal-title">📬 邮箱授权</h2>
                <div class="modal-header-actions">
                    <button class="btn-push-settings" onclick="togglePushSettingsPopup(event)" title="推送设置">🔔</button>
                    <button class="btn-close" onclick="closeEmailManager()">✕</button>
                </div>
                <!-- 推送设置弹出层 -->
                <div class="push-settings-popup" id="pushSettingsPopup">
                    <div class="push-settings-title">验证码提醒方式</div>
                    <label class="push-toggle" title="新验证码会显示在通知面板列表中">
                        <span class="push-label">🔔 通知面板</span>
                        <input type="checkbox" id="pushNotify" checked onchange="savePushSettings()">
                        <span class="toggle-switch"></span>
                    </label>
                    <label class="push-toggle" title="收到验证码时弹出浮窗，方便快速复制">
                        <span class="push-label">💬 即时弹窗</span>
                        <input type="checkbox" id="pushToast" checked onchange="savePushSettings()">
                        <span class="toggle-switch"></span>
                    </label>
                    <label class="push-toggle" title="在铃铛图标上显示未读验证码数量">
                        <span class="push-label">🔢 未读角标</span>
                        <input type="checkbox" id="pushBadge" checked onchange="savePushSettings()">
                        <span class="toggle-switch"></span>
                    </label>
                </div>
            </div>
            <div class="modal-body email-manager-body">
                <!-- 已授权邮箱 -->
                <div class="email-section">
                    <div class="email-section-title">✅ 已授权邮箱</div>
                    <div class="authorized-emails-list" id="authorizedEmailsList">
                        <div class="emails-empty">暂无已授权邮箱</div>
                    </div>
                </div>
                <!-- 待授权邮箱 -->
                <div class="email-section">
                    <div class="email-section-title">💡 待授权邮箱 <span class="section-hint">从账号辅助邮箱收集</span></div>
                    <div class="pending-emails-list" id="pendingEmailsList">
                        <div class="emails-empty">暂无待授权邮箱</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeEmailManager()">关闭</button>
                <button class="btn-save" onclick="openAddEmailModal()">➕ 添加邮箱</button>
            </div>
        </div>
    </div>

    <!-- 添加授权邮箱模态框 -->
    <div class="modal-overlay" id="addEmailModal">
        <div class="modal email-modal">
            <div class="modal-header">
                <h2 class="modal-title">➕ 添加授权邮箱</h2>
                <button class="btn-close" onclick="closeAddEmailModal()">✕</button>
            </div>
            <div class="modal-body">
                <!-- 折叠式邮箱选择列表 -->
                <div class="provider-accordion" id="providerAccordion">
                    <!-- Gmail -->
                    <div class="provider-item" data-provider="gmail">
                        <div class="provider-header" onclick="toggleProviderPanel('gmail')">
                            <div class="provider-header-left">
                                <div class="provider-icon gmail">📧</div>
                                <div class="provider-info">
                                    <div class="provider-name">Gmail</div>
                                    <div class="provider-desc">OAuth 官方授权</div>
                                </div>
                            </div>
                            <div class="provider-toggle">▼</div>
                        </div>
                        <div class="provider-panel" id="gmailPanel">
                            <div class="oauth-config-inner" id="gmailOauthConfig">
                                <div class="form-group">
                                    <label class="form-label">Client ID</label>
                                    <input type="text" class="form-input" id="gmailClientId" placeholder="从 Google Cloud Console 获取">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Client Secret</label>
                                    <input type="password" class="form-input" id="gmailClientSecret" placeholder="从 Google Cloud Console 获取">
                                </div>
                                <div class="oauth-help-actions">
                                    <button type="button" class="btn-help" onclick="showHelpModal('gmail')" title="查看详细教程">❓ 教程</button>
                                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="btn-get-credentials">🔗 前往获取</a>
                                </div>
                            </div>
                            <div class="provider-auth-info">
                                <span class="auth-badge oauth">OAuth 2.0</span>
                                <span class="auth-hint">只读权限，不存储密码</span>
                            </div>
                            <button class="btn-provider-auth" onclick="startProviderAuth('gmail')">🔗 开始授权</button>
                        </div>
                    </div>
                    
                    <!-- Outlook -->
                    <div class="provider-item" data-provider="outlook">
                        <div class="provider-header" onclick="toggleProviderPanel('outlook')">
                            <div class="provider-header-left">
                                <div class="provider-icon outlook">📧</div>
                                <div class="provider-info">
                                    <div class="provider-name">Outlook</div>
                                    <div class="provider-desc">OAuth 官方授权</div>
                                </div>
                            </div>
                            <div class="provider-toggle">▼</div>
                        </div>
                        <div class="provider-panel" id="outlookPanel">
                            <div class="oauth-config-inner" id="outlookOauthConfig">
                                <div class="form-group">
                                    <label class="form-label">Client ID</label>
                                    <input type="text" class="form-input" id="outlookClientId" placeholder="从 Azure Portal 获取">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Client Secret</label>
                                    <input type="password" class="form-input" id="outlookClientSecret" placeholder="从 Azure Portal 获取">
                                </div>
                                <div class="oauth-help-actions">
                                    <button type="button" class="btn-help" onclick="showHelpModal('outlook')" title="查看详细教程">❓ 教程</button>
                                    <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank" class="btn-get-credentials">🔗 前往获取</a>
                                </div>
                            </div>
                            <div class="provider-auth-info">
                                <span class="auth-badge oauth">OAuth 2.0</span>
                                <span class="auth-hint">只读权限，不存储密码</span>
                            </div>
                            <button class="btn-provider-auth" onclick="startProviderAuth('outlook')">🔗 开始授权</button>
                        </div>
                    </div>
                    
                    <!-- QQ邮箱 -->
                    <div class="provider-item" data-provider="qq">
                        <div class="provider-header" onclick="toggleProviderPanel('qq')">
                            <div class="provider-header-left">
                                <div class="provider-icon qq">📧</div>
                                <div class="provider-info">
                                    <div class="provider-name">QQ邮箱</div>
                                    <div class="provider-desc">IMAP + 授权码</div>
                                </div>
                            </div>
                            <div class="provider-toggle">▼</div>
                        </div>
                        <div class="provider-panel" id="qqPanel">
                            <div class="imap-config-inner">
                                <div class="form-group">
                                    <label class="form-label">QQ邮箱地址</label>
                                    <input type="email" class="form-input" id="qqEmail" placeholder="123456789@qq.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">授权码 <span class="label-hint">（非QQ密码）</span></label>
                                    <input type="password" class="form-input" id="qqPassword" placeholder="在QQ邮箱设置中获取">
                                </div>
                                <div class="oauth-help-actions">
                                    <button type="button" class="btn-help" onclick="showHelpModal('qq')" title="查看详细教程">❓ 教程</button>
                                    <a href="https://mail.qq.com" target="_blank" class="btn-get-credentials">🔗 前往获取</a>
                                </div>
                            </div>
                            <div class="provider-auth-info">
                                <span class="auth-badge imap">IMAP</span>
                                <span class="auth-hint">授权码加密存储</span>
                            </div>
                            <button class="btn-provider-auth" onclick="startProviderAuth('qq')">🔗 验证连接</button>
                        </div>
                    </div>
                    
                    <!-- 通用IMAP -->
                    <div class="provider-item" data-provider="imap">
                        <div class="provider-header" onclick="toggleProviderPanel('imap')">
                            <div class="provider-header-left">
                                <div class="provider-icon imap">⚙️</div>
                                <div class="provider-info">
                                    <div class="provider-name">通用IMAP</div>
                                    <div class="provider-desc">自定义服务器</div>
                                </div>
                            </div>
                            <div class="provider-toggle">▼</div>
                        </div>
                        <div class="provider-panel" id="imapPanel">
                            <div class="imap-config-inner">
                                <div class="form-group">
                                    <label class="form-label">邮箱地址</label>
                                    <input type="email" class="form-input" id="imapEmail" placeholder="your@email.com">
                                </div>
                                <div class="form-row">
                                    <div class="form-group flex-grow">
                                        <label class="form-label">IMAP 服务器</label>
                                        <input type="text" class="form-input" id="imapServer" placeholder="imap.example.com">
                                    </div>
                                    <div class="form-group w100">
                                        <label class="form-label">端口</label>
                                        <input type="number" class="form-input" id="imapPort" value="993">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">密码/授权码</label>
                                    <input type="password" class="form-input" id="imapPassword" placeholder="邮箱密码或授权码">
                                </div>
                                <div class="imap-presets">
                                    <span class="preset-label">常用配置：</span>
                                    <button type="button" class="btn-preset" onclick="fillImapPreset('163')">163</button>
                                    <button type="button" class="btn-preset" onclick="fillImapPreset('126')">126</button>
                                    <button type="button" class="btn-preset" onclick="fillImapPreset('sina')">新浪</button>
                                </div>
                            </div>
                            <div class="provider-auth-info">
                                <span class="auth-badge imap">IMAP</span>
                                <span class="auth-hint">凭证加密存储</span>
                            </div>
                            <button class="btn-provider-auth" onclick="startProviderAuth('imap')">🔗 验证连接</button>
                        </div>
                    </div>
                </div>
                
                <!-- 安全说明（底部固定） -->
                <div class="auth-info-footer">
                    <div class="auth-info-icon">🔒</div>
                    <div class="auth-info-text">所有凭证均加密存储在您的服务器上，AccBox 不会上传任何数据到第三方</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAddEmailModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 验证码弹窗 Toast -->
    <div class="code-toast" id="codeToast">
        <div class="toast-header">
            <span class="toast-title">
                <span class="toast-icon">📬</span>
                <span id="toastService">验证码</span>
            </span>
            <button class="toast-close" onclick="closeCodeToast()">✕</button>
        </div>
        <div class="toast-body">
            <div class="toast-account" id="toastAccount"></div>
            <div class="toast-code" id="toastCode" onclick="copyToastCode()">------</div>
            <div class="toast-timer">
                <span>⏱️ 剩余 </span>
                <span id="toastTimer">5:00</span>
            </div>
        </div>
    </div>

    <!-- 移动端更多菜单面板 -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMoreMenu()"></div>
    <div class="mobile-menu-panel" id="mobileMenuPanel">
        <div class="mobile-menu-header">
            <span>更多操作</span>
            <button class="btn-close-sm" onclick="closeMoreMenu()">✕</button>
        </div>
        <div class="mobile-menu-body">
            <div class="mobile-menu-item" onclick="openAddModal();closeMoreMenu()"><span class="menu-icon">➕</span>添加账号</div>
            <div class="mobile-menu-item" onclick="openImportModal();closeMoreMenu()"><span class="menu-icon">📥</span>导入数据</div>
            <div class="mobile-menu-item" onclick="exportData();closeMoreMenu()"><span class="menu-icon">📤</span>导出数据</div>
            <div class="mobile-menu-item" onclick="showBackupModal();closeMoreMenu()"><span class="menu-icon">📦</span>数据备份</div>
            <div class="mobile-menu-item" onclick="toggleTimeBadge();closeMoreMenu()">
                <span class="menu-icon" id="mobileTimeBadgeIcon">⏰️</span>
                时间提醒
                <span class="toggle-status" id="mobileTimeBadgeStatus">开</span>
            </div>
            <div class="mobile-menu-divider"></div>
            <div class="mobile-menu-item" onclick="openEmailManager();closeMoreMenu()">
                <span class="menu-icon">📬</span>邮箱授权
                <span class="menu-badge" id="mobileEmailBadge" style="display:none">0</span>
            </div>
        </div>
    </div>

    <!-- 邮箱配置帮助弹窗 -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal help-modal">
            <div class="modal-header">
                <h3 id="helpModalTitle">配置教程</h3>
                <button class="btn-close" onclick="closeHelpModal()">✕</button>
            </div>
            <div class="modal-body help-modal-body" id="helpModalContent">
                <!-- 内容由 JS 动态填充 -->
            </div>
        </div>
    </div>

    <!-- jsQR 二维码识别库 -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        // 动态加载JS，先加载flags，再加载app
        const flagsScript = document.createElement('script');
        flagsScript.src = 'flags.js?v=' + Date.now();
        flagsScript.onload = function() {
            const appScript = document.createElement('script');
            appScript.src = 'app.js?v=' + Date.now();
            document.body.appendChild(appScript);
        };
        document.body.appendChild(flagsScript);
    </script>
</body>
</html>
